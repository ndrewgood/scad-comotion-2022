{"version":3,"sources":["../../../src/utils/page-ssr-module/bundle-webpack.ts"],"names":["extensions","outputDir","path","join","process","cwd","cacheLocation","writeQueryContext","staticQueriesByTemplate","components","waitingForWrites","pageTemplate","values","staticQueryHashes","get","componentPath","push","componentChunkName","Promise","all","then","createPageSSRBundle","rootDir","reporter","isVerbose","webpackStats","toInline","query","assets","compiler","name","mode","entry","__dirname","output","filename","libraryTarget","target","externalsPresets","node","cache","type","buildDependencies","config","__filename","externals","mod","builtinModules","reduce","acc","builtinModule","module","rules","test","resolve","byDependency","esm","fullySpecified","parser","amd","use","loader","require","options","outputAssetBase","alias","plugins","webpack","DefinePlugin","INLINED_TEMPLATE_TO_DETAILS","JSON","stringify","env","GATSBY_WEBPACK_LOGGING","includes","WebpackLoggingPlugin","filter","Boolean","reject","run","err","stats","close","closeErr","compilation"],"mappings":"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","sourcesContent":["import * as path from \"path\"\nimport webpack from \"webpack\"\nimport mod from \"module\"\nimport { WebpackLoggingPlugin } from \"../../utils/webpack/plugins/webpack-logging\"\nimport reporter from \"gatsby-cli/lib/reporter\"\nimport type { ITemplateDetails } from \"./entry\"\n\nimport {\n  getScriptsAndStylesForTemplate,\n  readWebpackStats,\n} from \"../client-assets-for-template\"\nimport { writeStaticQueryContext } from \"../static-query-utils\"\nimport { IGatsbyState } from \"../../redux/types\"\n\ntype Reporter = typeof reporter\n\nconst extensions = [`.mjs`, `.js`, `.json`, `.node`, `.ts`, `.tsx`]\nconst outputDir = path.join(process.cwd(), `.cache`, `page-ssr`)\nconst cacheLocation = path.join(process.cwd(), `.cache`, `webpack`, `page-ssr`)\n\nexport async function writeQueryContext({\n  staticQueriesByTemplate,\n  components,\n}: {\n  staticQueriesByTemplate: IGatsbyState[\"staticQueriesByTemplate\"]\n  components: IGatsbyState[\"components\"]\n}): Promise<void> {\n  const waitingForWrites: Array<Promise<unknown>> = []\n  for (const pageTemplate of components.values()) {\n    const staticQueryHashes =\n      staticQueriesByTemplate.get(pageTemplate.componentPath) || []\n\n    waitingForWrites.push(\n      writeStaticQueryContext(\n        staticQueryHashes,\n        pageTemplate.componentChunkName\n      )\n    )\n  }\n\n  return Promise.all(waitingForWrites).then(() => {})\n}\n\nexport async function createPageSSRBundle({\n  rootDir,\n  components,\n  staticQueriesByTemplate,\n  reporter,\n  isVerbose = false,\n}: {\n  rootDir: string\n  components: IGatsbyState[\"components\"]\n  staticQueriesByTemplate: IGatsbyState[\"staticQueriesByTemplate\"]\n  reporter: Reporter\n  isVerbose?: boolean\n}): Promise<webpack.Compilation | undefined> {\n  const webpackStats = await readWebpackStats(path.join(rootDir, `public`))\n\n  const toInline: Record<string, ITemplateDetails> = {}\n  for (const pageTemplate of components.values()) {\n    const staticQueryHashes =\n      staticQueriesByTemplate.get(pageTemplate.componentPath) || []\n\n    toInline[pageTemplate.componentChunkName] = {\n      query: pageTemplate.query,\n      staticQueryHashes,\n      assets: await getScriptsAndStylesForTemplate(\n        pageTemplate.componentChunkName,\n        webpackStats\n      ),\n    }\n  }\n\n  const compiler = webpack({\n    name: `Page Engine`,\n    mode: `none`,\n    entry: path.join(__dirname, `entry.js`),\n    output: {\n      path: outputDir,\n      filename: `index.js`,\n      libraryTarget: `commonjs`,\n    },\n    target: `node`,\n    externalsPresets: {\n      node: false,\n    },\n    cache: {\n      type: `filesystem`,\n      name: `page-ssr`,\n      cacheLocation,\n      buildDependencies: {\n        config: [__filename],\n      },\n    },\n    // those are required in some runtime paths, but we don't need them\n    externals: [\n      /^\\.\\/routes/,\n      `electron`, // :shrug: `got` seems to have electron specific code path\n      mod.builtinModules.reduce((acc, builtinModule) => {\n        if (builtinModule === `fs`) {\n          acc[builtinModule] = `global _actualFsWrapper`\n        } else {\n          acc[builtinModule] = `commonjs ${builtinModule}`\n        }\n\n        return acc\n      }, {}),\n    ],\n    module: {\n      rules: [\n        {\n          test: /\\.m?js$/,\n          type: `javascript/auto`,\n          resolve: {\n            byDependency: {\n              esm: {\n                fullySpecified: false,\n              },\n            },\n          },\n        },\n        {\n          // For node binary relocations, include \".node\" files as well here\n          test: /\\.(m?js|node)$/,\n          // it is recommended for Node builds to turn off AMD support\n          parser: { amd: false },\n          use: {\n            loader: require.resolve(`@vercel/webpack-asset-relocator-loader`),\n            options: {\n              outputAssetBase: `assets`,\n            },\n          },\n        },\n        {\n          test: /\\.txt/,\n          type: `asset/resource`,\n        },\n      ],\n    },\n    resolve: {\n      extensions,\n      alias: {\n        \".cache\": `${rootDir}/.cache/`,\n      },\n    },\n    plugins: [\n      new webpack.DefinePlugin({\n        INLINED_TEMPLATE_TO_DETAILS: JSON.stringify(toInline),\n      }),\n      process.env.GATSBY_WEBPACK_LOGGING?.includes(`page-engine`)\n        ? new WebpackLoggingPlugin(rootDir, reporter, isVerbose)\n        : false,\n    ].filter(Boolean) as Array<webpack.WebpackPluginInstance>,\n  })\n\n  return new Promise((resolve, reject) => {\n    compiler.run((err, stats) => {\n      compiler.close(closeErr => {\n        if (err) {\n          return reject(err)\n        }\n        if (closeErr) {\n          return reject(closeErr)\n        }\n        return resolve(stats?.compilation)\n      })\n    })\n  })\n}\n"],"file":"bundle-webpack.js"}